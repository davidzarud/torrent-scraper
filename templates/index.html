<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torrent Scraper</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
<div class="bg-blue-800 text-white">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
        <div class="text-2xl font-bold">Torrent Scraper</div>
        <div>
            <a href="/movies" class="text-lg px-4 py-2 hover:bg-blue-700 rounded {% if category == 'movies' %}bg-blue-600{% endif %}">Movies</a>
            <a href="/tv" class="text-lg px-4 py-2 hover:bg-blue-700 rounded {% if category == 'tv' %}bg-blue-600{% endif %}">TV Shows</a>
        </div>
    </div>
</div>

<div class="container mx-auto px-4 py-8">
    <!-- Search form -->
    <form class="flex mb-4" action="/{{ category }}" method="GET">
        <input type="text" class="flex-grow border rounded-l px-4 py-2" name="search" placeholder="Search..." value="{{ search_query }}">
        <button type="submit" class="bg-blue-800 text-white px-4 py-2 rounded-r">Search</button>
    </form>

    <!-- Table -->
    <div class="bg-white shadow-md rounded">
        <table class="min-w-full table-auto">
            <thead>
            <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                <th class="py-3 px-6 text-left">Title</th>
                <th class="py-3 px-6 text-left">IMDB Link</th>
                <th class="py-3 px-6 text-left">Magnet Link</th>
                <th class="py-3 px-6 text-left">Category</th>
                <th class="py-3 px-6 text-left">Size</th>
                <th class="py-3 px-6 text-left">Seeders</th>
                <th class="py-3 px-6 text-left">Leechers</th>
                <th class="py-3 px-6 text-left">Date Uploaded</th>
            </tr>
            </thead>
            <tbody class="text-gray-600 text-sm font-light">
            {% for torrent in torrents %}
            <tr class="border-b border-gray-200 hover:bg-gray-100">
                <td class="py-3 px-6 text-left whitespace-nowrap">{{ torrent.title }}</td>
                <td class="py-3 px-6 text-left">
                    <a href="#" onclick="fetchIMDbLink('{{ torrent.link }}'); return false;" class="text-blue-500 hover:underline">Get IMDb Link</a>
                </td>
                <td class="py-3 px-6 text-left">
                    <a href="#" onclick="fetchAndCopyMagnetLink('{{ torrent.link }}'); return false;" class="text-blue-500 hover:underline">Get Magnet Link</a>
                </td>
                <td class="py-3 px-6 text-left">{{ torrent.category }}</td>
                <td class="py-3 px-6 text-left">{{ torrent.size }}</td>
                <td class="py-3 px-6 text-left">{{ torrent.seeders }}</td>
                <td class="py-3 px-6 text-left">{{ torrent.leechers }}</td>
                <td class="py-3 px-6 text-left">{{ torrent.date_uploaded }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    {% if not search_query %}
    <nav class="mt-4">
        <ul class="flex justify-center">
            {% if page > 1 %}
            <li><a href="?page={{ page - 1 }}" class="mx-2 px-4 py-2 bg-blue-800 text-white rounded hover:bg-blue-700">Previous</a></li>
            {% endif %}
            <li><a href="?page={{ page + 1 }}" class="mx-2 px-4 py-2 bg-blue-800 text-white rounded hover:bg-blue-700">Next</a></li>
        </ul>
    </nav>
    {% endif %}
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    function fetchAndCopyMagnetLink(torrentUrl) {
        $.ajax({
            url: '/get_magnet_link',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 'torrent_url': torrentUrl }),
            success: function(response) {
                if (response.success) {
                    alert('Torrent added to qBittorrent!');
                } else {
                    alert('Failed to add torrent to qBittorrent. Error: ' + response.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('Failed to fetch magnet link:', error);
                alert('Failed to fetch magnet link. Please try again later.');
            }
        });
    }

    function fetchIMDbLink(torrentUrl) {
        $.ajax({
            url: '/get_imdb_link',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 'torrent_url': torrentUrl }),
            success: function(response) {
                if (response.success) {
                    window.open(response.imdb_link, '_blank');
                } else {
                    alert('Failed to fetch IMDb link.');
                }
            },
            error: function(xhr, status, error) {
                console.error('Failed to fetch IMDb link:', error);
                alert('Failed to fetch IMDb link. Please try again later.');
            }
        });
    }
</script>
</body>
</html>
